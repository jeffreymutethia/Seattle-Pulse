services:
  db:
    image: postgres:13
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-seattle_pulse}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-seattle_pulse}"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: ["web"]
    environment:
      APP_ENV: ${APP_ENV:-local}
      APP_ENV_FOR_SESSION: ${APP_ENV_FOR_SESSION:-true}
      FLASK_ENV: ${FLASK_ENV:-development}
      FLASK_APP: ${FLASK_APP:-run:app}
      PORT: ${PORT:-5000}
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@db:5432/seattle_pulse}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/0}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/0}
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-me}
      SECURITY_PASSWORD_SALT: ${SECURITY_PASSWORD_SALT:-dev-password-salt-change-me}
      PASSWORD_RESET_SALT: ${PASSWORD_RESET_SALT:-dev-reset-salt-change-me}
      LOCAL_AWS_ACCESS_KEY_ID: ${LOCAL_AWS_ACCESS_KEY_ID:-test}
      LOCAL_AWS_SECRET_ACCESS_KEY: ${LOCAL_AWS_SECRET_ACCESS_KEY:-test}
      LOCAL_S3_ENDPOINT_URL: ${LOCAL_S3_ENDPOINT_URL:-http://localstack:4566}
      USE_LOCALSTACK: ${USE_LOCALSTACK:-false}
      PERFORM_STARTUP_FETCH: ${PERFORM_STARTUP_FETCH:-false}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      FRONTEND_URL_LOCAL: ${FRONTEND_URL_LOCAL:-http://localhost:3000}
      WAITLIST_SNS_ARN: ${WAITLIST_SNS_ARN:-}
      USE_GMAIL_FOR_WAITLIST_EMAILS: ${USE_GMAIL_FOR_WAITLIST_EMAILS:-false}
      LOGGING_LEVEL: ${LOGGING_LEVEL:-DEBUG}
    ports:
      - "5050:5000"
    volumes:
      - ./backend:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 15s
      timeout: 5s
      retries: 15
      start_period: 20s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_APP_ENV: ${NEXT_PUBLIC_APP_ENV:-local}
      INTERNAL_API_BASE_URL: ${INTERNAL_API_BASE_URL:-http://backend:5000/api/v1}
      INTERNAL_API_URL_NOTIFICATION: ${INTERNAL_API_URL_NOTIFICATION:-http://backend:5000}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:5050/api/v1}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:5050/api/v1}
      NEXT_PUBLIC_API_URL_NOTIFICATION: ${NEXT_PUBLIC_API_URL_NOTIFICATION:-http://localhost:5050}
      NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}
      NEXT_PUBLIC_SENTRY_DSN: ${NEXT_PUBLIC_SENTRY_DSN:-}
      SENTRY_DSN: ${SENTRY_DSN:-}
      NEXT_PUBLIC_MIXPANEL_TOKEN: ${NEXT_PUBLIC_MIXPANEL_TOKEN:-}
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/usr/src/app
      - frontend_node_modules:/usr/src/app/node_modules
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://127.0.0.1:3000').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 30s

  localstack:
    image: localstack/localstack
    profiles: ["localstack"]
    environment:
      SERVICES: s3
      AWS_DEFAULT_REGION: us-east-1
    ports:
      - "4566:4566"
    volumes:
      - localstack_data:/var/lib/localstack

volumes:
  postgres_data:
  frontend_node_modules:
  localstack_data:
